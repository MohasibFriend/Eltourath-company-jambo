<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Eltourath Companies â€“ Dynamic Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS for Excel reading in browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #e0edff;
      --primary-dark: #1d4ed8;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
      --radius-xl: 20px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.10);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #e0edff 0, #f9fafb 55%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 24px 16px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .wrapper {
      width: 100%;
      max-width: 1200px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 24px 24px 18px;
      border: 1px solid #e5e7eb;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 18px;
    }

    .title-block h1 {
      font-size: 1.7rem;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag-pill {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      color: var(--text-muted);
      background: #f3f4f6;
      white-space: nowrap;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
      border: 1px solid rgba(191, 219, 254, 0.9);
    }

    .btn.secondary {
      background: #f3f4f6;
      color: var(--text-main);
      box-shadow: none;
      border-color: #d1d5db;
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 0.8rem;
      box-shadow: none;
    }

    .btn.danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
      box-shadow: none;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none !important;
      box-shadow: none !important;
    }

    .btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.45);
    }

    .btn-icon {
      font-size: 1rem;
      line-height: 1;
    }

    .file-input-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .file-input-label input[type="file"] {
      font-size: 0.85rem;
      padding: 4px;
    }

    .search-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }

    .search-input {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 10px;
      font-size: 0.85rem;
      min-width: 180px;
      background: #f9fafb;
      color: var(--text-main);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
      background: #ffffff;
    }

    .edit-switch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .edit-switch-indicator {
      width: 30px;
      height: 16px;
      border-radius: 999px;
      background: #e5e7eb;
      position: relative;
      flex-shrink: 0;
    }

    .edit-switch-indicator::before {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #ffffff;
      top: 1px;
      left: 2px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.35);
      transition: transform 0.18s ease, background 0.18s ease;
    }

    .edit-switch.on {
      border-color: var(--primary);
      background: #e0edff;
      color: #1f2937;
    }

    .edit-switch.on .edit-switch-indicator {
      background: #bfdbfe;
    }

    .edit-switch.on .edit-switch-indicator::before {
      transform: translateX(12px);
      background: var(--primary);
    }

    .edit-controls {
      display: none;
      margin-bottom: 10px;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .status {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 4px 2px 2px;
      min-height: 1em;
    }

    .status.error {
      color: var(--danger);
    }

    .status.success {
      color: var(--success);
    }

    .table-shell {
      margin-top: 4px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #f9fafb;
      overflow: hidden;
    }

    .table-toolbar {
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, #eff6ff, #f9fafb);
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .table-toolbar .count {
      font-weight: 500;
      color: var(--text-main);
    }

    .table-container {
      max-height: 440px;
      overflow: auto;
      background: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      color: var(--text-main);
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    thead tr {
      background: #f3f4f6;
      box-shadow: 0 1px 0 #e5e7eb;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 10px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:nth-child(odd) {
      background: #ffffff;
    }

    td[contenteditable="true"] {
      cursor: text;
    }

    td[contenteditable="true"]:focus {
      outline: 1px solid var(--primary);
      outline-offset: -1px;
      background: #eff6ff;
    }

    .pk-cell {
      font-weight: 600;
      color: #111827;
    }

    .row-actions-btn {
      border-radius: 999px;
      border: 1px solid #fecaca;
      background: #fee2e2;
      color: #b91c1c;
      font-size: 0.7rem;
      padding: 2px 8px;
      cursor: pointer;
    }

    .row-actions-btn:hover {
      background: #fecaca;
    }

    /* ====== Alarm UI ====== */
    .alarm-btn {
      position: relative;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      padding: 7px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-main);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .alarm-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.10);
    }

    .alarm-bell {
      font-size: 1.05rem;
      line-height: 1;
    }

    .alarm-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 999px;
      background: #dc2626;
      color: #fff;
      font-size: 0.72rem;
      display: none;
      align-items: center;
      justify-content: center;
      border: 2px solid #fff;
      box-shadow: 0 8px 18px rgba(220, 38, 38, 0.25);
    }

    .alarm-panel {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      width: min(520px, calc(100vw - 48px));
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
      overflow: hidden;
      display: none;
      z-index: 10;
    }

    .alarm-panel-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(90deg, #eff6ff, #ffffff);
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .alarm-panel-header strong {
      color: var(--text-main);
      font-weight: 600;
    }

    .alarm-panel-body {
      max-height: 320px;
      overflow: auto;
    }

    .alarm-item {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .alarm-item:last-child {
      border-bottom: none;
    }

    .alarm-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-top: 4px;
      flex-shrink: 0;
      background: #e5e7eb;
    }

    .alarm-dot.critical {
      background: #dc2626;
    }

    .alarm-dot.warning {
      background: #f59e0b;
    }

    .alarm-text {
      font-size: 0.85rem;
      color: var(--text-main);
      line-height: 1.35;
    }

    .alarm-sub {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    tr.alarm-critical td {
      background: #fee2e2 !important;
    }

    tr.alarm-warning td {
      background: #fef9c3 !important;
    }

    tr.alarm-critical td:first-child,
    tr.alarm-warning td:first-child {
      border-left: 4px solid transparent;
    }

    tr.alarm-critical td:first-child {
      border-left-color: #dc2626 !important;
    }

    tr.alarm-warning td:first-child {
      border-left-color: #f59e0b !important;
    }

    /* ===== Loading Overlay ===== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.35);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
      min-width: 220px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .spinner {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--primary);
      animation: spin 0.9s linear infinite;
    }

    .loading-text {
      font-size: 0.9rem;
      color: var(--text-main);
      font-weight: 600;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ===== Fake details modal ===== */
    #fakeModal .loading-card {
      align-items: flex-start;
      max-width: 560px;
      width: min(560px, calc(100vw - 48px));
      gap: 0;
    }

    /* Ø®Ù„ÙŠ Ø§Ù„ÙƒÙ„Ø§Ù… ÙÙŠ Ù†Øµ Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± */
    #fakeModalBody {
      text-align: center;
    }

    #fakeModalBody hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 10px 0;
    }

    .fake-invoice-block {
      text-align: center;
      padding: 8px 0;
    }

    .fake-invoice-block strong {
      display: block;
      margin-bottom: 8px;
      color: #991b1b;
      font-weight: 800;
    }

    /* ===== Fixed Media Queries ===== */
    @media (max-width: 900px) {
      body {
        padding: 16px 10px;
      }

      .card {
        padding: 18px 14px 14px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .title-block h1 {
        font-size: 1.35rem;
      }

      .tag-pill {
        align-self: flex-start;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .btn,
      .controls .btn {
        width: 100%;
        justify-content: center;
      }

      .search-wrapper {
        width: 100%;
        margin-left: 0;
        justify-content: flex-start;
        gap: 8px;
      }

      .search-wrapper>span {
        white-space: nowrap;
      }

      .search-input {
        width: 100%;
        min-width: 0;
      }

      #alarmWrap {
        width: 100%;
      }

      .alarm-btn {
        width: 100%;
        justify-content: center;
      }

      .alarm-panel {
        left: 0;
        right: 0;
        width: 100%;
        top: calc(100% + 8px);
      }

      .edit-switch {
        width: 100%;
        justify-content: center;
      }

      .edit-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .file-input-label {
        width: 100%;
        justify-content: space-between;
        gap: 10px;
      }

      .file-input-label input[type="file"] {
        width: 100%;
      }

      .table-container {
        max-height: 58vh;
      }

      table {
        font-size: 0.78rem;
      }

      th,
      td {
        padding: 6px 8px;
      }
    }

    @media (max-width: 480px) {
      .title-block h1 {
        font-size: 1.2rem;
      }

      .tag-pill {
        font-size: 0.75rem;
        padding: 3px 9px;
      }

      .table-container {
        max-height: 55vh;
      }

      table {
        font-size: 0.74rem;
      }

      th,
      td {
        padding: 6px 7px;
      }
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="card">
      <div class="header">
        <div class="title-block">
          <h1>Eltourath Companies</h1>
        </div>
        <div class="tag-pill">Editable grid Â· Excel-style workflow</div>
      </div>

      <div class="controls">
        <button id="btnReload" class="btn">
          <span class="btn-icon">âŸ³</span>
          <span>Load data from server</span>
        </button>

        <!-- âœ… NEW: Integration Portal Button -->
        <button id="btnIntegrationPortal" class="btn secondary" type="button" title="Open Integration Portal with random userId">
          <span class="btn-icon">ğŸ”—</span>
          <span>Integration portal</span>
        </button>

        <div class="search-wrapper">
          <span style="font-size:0.8rem;color:var(--text-muted);">Search:</span>
          <input id="searchInput" class="search-input" type="text" placeholder="Search in any column..." />
        </div>

        <!-- Alarm icon -->
        <div id="alarmWrap" style="position:relative; display:inline-flex; align-items:center;">
          <button id="alarmBtn" type="button" class="alarm-btn" title="Alarms">
            <span class="alarm-bell">ğŸ””</span>
            <span style="font-size:0.85rem;color:var(--text-muted);">Alarms</span>
            <span id="alarmBadge" class="alarm-badge">0</span>
          </button>

          <div id="alarmPanel" class="alarm-panel" role="dialog" aria-label="Alarms panel">
            <div class="alarm-panel-header">
              <div><strong id="alarmTitle">Alarms</strong> <span id="alarmSummary"></span></div>
              <button id="alarmClose" type="button" class="btn small secondary" style="padding:5px 10px;">Close</button>
            </div>
            <div id="alarmList" class="alarm-panel-body"></div>
          </div>
        </div>

        <button id="editToggleBtn" type="button" class="edit-switch" aria-pressed="false">
          <span class="edit-switch-indicator"></span>
          <span class="edit-switch-text">Edit mode</span>
        </button>
      </div>

      <div id="editControls" class="edit-controls">
        <label class="file-input-label">
          <span>Excel file:</span>
          <input id="excelInput" type="file" accept=".xlsx,.xls" />
        </label>

        <button id="btnUpload" class="btn secondary" disabled>
          <span class="btn-icon">â¬†</span>
          <span>Save table to server</span>
        </button>

        <button id="btnAddRow" class="btn small secondary">
          <span class="btn-icon">ï¼‹</span>
          <span>Add row</span>
        </button>

        <button id="btnCancelEdit" class="btn small danger">
          <span class="btn-icon">âœ•</span>
          <span>Cancel edit</span>
        </button>
      </div>

      <div id="status" class="status"></div>

      <div class="table-shell">
        <div class="table-toolbar">
          <div class="hint"></div>
          <div class="count" id="rowCount">0 rows</div>
        </div>

        <div class="table-container">
          <table id="companiesTable">
            <thead>
              <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-card">
      <div class="spinner"></div>
      <div class="loading-text">Working...</div>
    </div>
  </div>

  <!-- Fake invoices details modal -->
  <div id="fakeModal" class="loading-overlay" aria-hidden="true">
    <div class="loading-card">
      <div style="width:100%;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;">
          <div style="font-weight:900;color:#991b1b;">ØªÙØµÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</div>
          <button id="fakeCloseBtn" class="btn small secondary" type="button" style="padding:5px 10px;">Close</button>
        </div>
        <div id="fakeModalBody" style="font-size:0.86rem;line-height:1.65;color:var(--text-main);"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= Config =========
    const API_URL = "https://lroggfzkgi.execute-api.us-east-1.amazonaws.com/prod/fetch-company";
    const PK_NAME = "Registration Number";
    const COMPANY_COL = "Company Name";
    const TYPE_COL = "Type of accounting";
    const FAKE_COL = "ÙÙˆØ§ØªÙŠØ± ÙˆÙ‡Ù…ÙŠÙ‡";

    // âœ… NEW: Integration Portal base link
    const INTEGRATION_PORTAL_BASE =
      "https://80260658-9969-4960-972a-30a2dce3136f-00-24ift3w1jdzt3.spock.replit.dev:8000/?userId=";

    const CURRENT_YEAR = new Date().getFullYear();
    const SALES_COL_PREFIX = "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª";
    const SALES_COL_CURRENT = `${SALES_COL_PREFIX} ${CURRENT_YEAR}`;

    const ALARM_LIMIT = 20000000;      // 20,000,000
    const ALARM_WARNING = 18000000;    // 18,000,000

    const IDX_COL_NAME = "#";

    const PRIORITY_COLS = [
      "Company Name",
      "Registration Number",
      "Type of accounting",
      "Gate type",
      "ÙÙˆØ§ØªÙŠØ± ÙˆÙ‡Ù…ÙŠÙ‡",
      "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª 2025",
      "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª 2025",
      "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø´ØªØ±ÙŠØ§Øª 2025",
      "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª 2025",
      "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª 2024",
      "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª 2024",
      "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø´ØªØ±ÙŠØ§Øª 2024",
      "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª 2024",
    ];

    // ========= DOM refs =========
    const btnReload = document.getElementById("btnReload");
    const btnUpload = document.getElementById("btnUpload");
    const btnAddRow = document.getElementById("btnAddRow");
    const btnCancelEdit = document.getElementById("btnCancelEdit");
    const excelInput = document.getElementById("excelInput");
    const searchInput = document.getElementById("searchInput");
    const editToggleBtn = document.getElementById("editToggleBtn");
    const editControls = document.getElementById("editControls");
    const statusEl = document.getElementById("status");
    const table = document.getElementById("companiesTable");
    const tableBody = table.querySelector("tbody");
    const tableHeaderRow = document.getElementById("tableHeaderRow");
    const rowCountEl = document.getElementById("rowCount");

    // âœ… NEW: Integration Portal button
    const btnIntegrationPortal = document.getElementById("btnIntegrationPortal");

    // Loading overlay
    const loadingOverlay = document.getElementById("loadingOverlay");
    const loadingTextEl = loadingOverlay.querySelector(".loading-text");

    // Fake modal
    const fakeModal = document.getElementById("fakeModal");
    const fakeModalBody = document.getElementById("fakeModalBody");
    const fakeCloseBtn = document.getElementById("fakeCloseBtn");

    function showOverlay(text = "Working...") {
      loadingTextEl.textContent = text;
      loadingOverlay.classList.add("show");
      loadingOverlay.setAttribute("aria-hidden", "false");
    }

    function hideOverlay() {
      loadingOverlay.classList.remove("show");
      loadingOverlay.setAttribute("aria-hidden", "true");
    }

    function openFakeModal() {
      fakeModal.classList.add("show");
      fakeModal.setAttribute("aria-hidden", "false");
    }

    function closeFakeModal() {
      fakeModal.classList.remove("show");
      fakeModal.setAttribute("aria-hidden", "true");
      fakeModalBody.innerHTML = "";
    }

    fakeCloseBtn.addEventListener("click", closeFakeModal);
    fakeModal.addEventListener("click", (e) => { if (e.target === fakeModal) closeFakeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeFakeModal(); });

    // ========= state =========
    let currentColumns = [];
    let hasDataInGrid = false;
    let fullItems = [];
    let baselineItems = [];
    let editMode = false;
    let rowIdCounter = 0;

    let alarms = [];

    // âœ… ÙŠÙ…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ÙŠÙÙ‚Ø¯Ø´ Ø§Ù„ÙÙˆÙƒØ³)
    let isTypingInCell = false;
    let _typingTimer = null;
    let _blurRenderTimer = null;

    function generateRowId() {
      rowIdCounter += 1;
      return "row_" + rowIdCounter + "_" + Date.now();
    }

    // ========= helpers =========
    function setStatus(text, type = "") {
      statusEl.textContent = text || "";
      statusEl.classList.remove("error", "success");
      if (type) statusEl.classList.add(type);
    }

    function setRowCount(count) {
      rowCountEl.textContent = `${count} row${count === 1 ? "" : "s"}`;
    }

    function setLoading(isLoading, text = "Working...") {
      btnReload.disabled = isLoading;
      btnUpload.disabled = isLoading || !hasDataInGrid || !editMode;
      btnIntegrationPortal.disabled = isLoading;
      if (isLoading) {
        showOverlay(text);
        setStatus(text, "");
      } else {
        hideOverlay();
      }
    }

    async function parseApiJson(resp) {
      const raw = await resp.text();
      console.log("Raw HTTP response:", raw);

      let data = {};
      try {
        data = JSON.parse(raw);
      } catch (e) {
        console.error("Failed to parse JSON:", e);
        return {};
      }

      if (data && typeof data.body === "string") {
        try {
          const inner = JSON.parse(data.body);
          console.log("Parsed inner body:", inner);
          return inner;
        } catch (e) {
          console.warn("Failed to parse inner body JSON:", e);
          return data;
        }
      }

      return data;
    }

    function isFilledCell(v) {
      if (v == null) return false;
      const s = String(v).trim();
      return s !== "";
    }

    function completenessScore(row) {
      let score = 0;
      for (const col of currentColumns) {
        if (col === "_rowId" || col === "_idx") continue;
        if (isFilledCell(row[col])) score += 1;
      }
      return score;
    }

    function normalizeDigits(str) {
      const map = {
        "Ù ": "0", "Ù¡": "1", "Ù¢": "2", "Ù£": "3", "Ù¤": "4", "Ù¥": "5", "Ù¦": "6", "Ù§": "7", "Ù¨": "8", "Ù©": "9",
        "Û°": "0", "Û±": "1", "Û²": "2", "Û³": "3", "Û´": "4", "Ûµ": "5", "Û¶": "6", "Û·": "7", "Û¸": "8", "Û¹": "9"
      };
      return String(str).replace(/[Ù -Ù©Û°-Û¹]/g, ch => map[ch] ?? ch);
    }

    function parseMoneyToNumber(v) {
      if (v == null) return NaN;
      let s = normalizeDigits(String(v)).trim();
      if (!s) return NaN;
      s = s.replace(/[,ØŒ\s]/g, "");
      s = s.replace(/[^\d.\-]/g, "");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function findSalesColumnName() {
      if (currentColumns.includes(SALES_COL_CURRENT)) return SALES_COL_CURRENT;
      const y = String(CURRENT_YEAR);
      const hit = currentColumns.find(c => c.includes(SALES_COL_PREFIX) && c.includes(y));
      if (hit) return hit;

      const salesCols = currentColumns.filter(c => c.includes(SALES_COL_PREFIX));
      if (!salesCols.length) return null;

      let best = salesCols[0];
      let bestYear = -Infinity;
      for (const c of salesCols) {
        const m = c.match(/(\d{4})/);
        const yr = m ? Number(m[1]) : -Infinity;
        if (yr > bestYear) { bestYear = yr; best = c; }
      }
      return best;
    }

    function getAlarmLevelForRow(row) {
      const type = (row[TYPE_COL] ?? "").toString().trim();
      if (type !== "Ù…Ø¨Ø³Ø·") return "none";

      const salesCol = findSalesColumnName();
      if (!salesCol) return "none";

      const sales = parseMoneyToNumber(row[salesCol]);
      if (!Number.isFinite(sales)) return "none";

      if (sales >= ALARM_LIMIT) return "critical";
      if (sales >= ALARM_WARNING) return "warning";
      return "none";
    }

    function hasFakeInvoices(row) {
      const v = (row[FAKE_COL] ?? "").toString().trim();
      return v !== "";
    }

    function applyAlarmRanksToRows() {
      for (const row of fullItems) {
        if (hasFakeInvoices(row)) {
          row._alarmLevel = "fake";
          row._alarmRank = -1;
          continue;
        }
        const level = getAlarmLevelForRow(row);
        row._alarmLevel = level;
        row._alarmRank = (level === "critical") ? 0 : (level === "warning") ? 1 : 2;
      }
    }

    function buildFakeAlarmsForRow(row) {
      const raw = (row[FAKE_COL] ?? "").toString().trim();
      if (!raw) return [];

      const parts = raw.split(" : ").map(s => s.trim()).filter(Boolean);
      const out = [];

      parts.forEach(p => {
        const pieces = p.split(",").map(x => (x ?? "").trim());
        const inv = pieces[0] || "-";
        const dt = pieces[1] || "-";
        const tax = pieces[2] || "-";
        const name = pieces[3] || "-";

        out.push({
          level: "critical",
          pk: (row[PK_NAME] ?? "").toString().trim(),
          company: (row["Company Name"] ?? "").toString().trim(),
          message: `ØªÙ… Ø±ØµØ¯ ÙØ§ØªÙˆØ±Ù‡ ÙˆÙ‡Ù…ÙŠÙ‡ Ø¨Ø±Ù‚Ù… ØªØ³Ø¬ÙŠÙ„ ${tax} ÙˆØ¨Ø§Ø³Ù… ${name} ÙˆØ±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ù‡ ${inv}`,
          _meta: { inv, dt, tax, name }
        });
      });

      return out;
    }

    function buildAlarms() {
      const salesCol = findSalesColumnName();
      alarms = [];

      for (const row of fullItems) {
        if (hasFakeInvoices(row)) alarms.push(...buildFakeAlarmsForRow(row));
      }

      if (salesCol) {
        for (const row of fullItems) {
          if (hasFakeInvoices(row)) continue;
          const level = getAlarmLevelForRow(row);
          if (level === "none") continue;

          const company = (row["Company Name"] ?? "").toString().trim() || "(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…)";
          const pk = (row[PK_NAME] ?? "").toString().trim();
          const sales = parseMoneyToNumber(row[salesCol]);

          const baseMsg = `Ø´Ø±ÙƒØ© ${company} Ù…Ø³Ø¬Ù„Ù‡ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù„Ù…Ø¨Ø³Ø·`;
          const msg =
            level === "critical"
              ? `${baseMsg} ÙˆØªØ®Ø·Øª Ù…Ø¨ÙŠØ¹ØªÙ‡Ø§ ØµØ§ÙÙŠÙ‡ 20 Ù…Ù„ÙŠÙˆÙ† Ø¬Ù†ÙŠÙ‡`
              : `${baseMsg} ÙˆØ§Ù‚ØªØ±Ø¨Øª Ù…Ù† 20 Ù…Ù„ÙŠÙˆÙ† Ø¬Ù†ÙŠÙ‡ (Ù‚Ø±Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¯)`;

          alarms.push({ level, pk, company, sales, salesCol, message: msg });
        }
      }

      const rank = { "critical": 0, "warning": 1, "none": 2 };
      alarms.sort((a, b) => {
        const aIsFake = !!a._meta;
        const bIsFake = !!b._meta;

        if (aIsFake !== bIsFake) return aIsFake ? -1 : 1;
        if (rank[a.level] !== rank[b.level]) return rank[a.level] - rank[b.level];

        const sa = Number.isFinite(a.sales) ? a.sales : 0;
        const sb = Number.isFinite(b.sales) ? b.sales : 0;
        return sb - sa;
      });

      updateAlarmUI();
    }

    // alarms UI
    const alarmBtn = document.getElementById("alarmBtn");
    const alarmBadge = document.getElementById("alarmBadge");
    const alarmPanel = document.getElementById("alarmPanel");
    const alarmList = document.getElementById("alarmList");
    const alarmClose = document.getElementById("alarmClose");
    const alarmTitle = document.getElementById("alarmTitle");
    const alarmSummary = document.getElementById("alarmSummary");

    function updateAlarmUI() {
      const count = alarms.length;
      if (count > 0) {
        alarmBadge.style.display = "inline-flex";
        alarmBadge.textContent = String(count);
      } else {
        alarmBadge.style.display = "none";
        alarmBadge.textContent = "0";
      }

      alarmTitle.textContent = `Alarms (${count})`;
      alarmSummary.textContent = count ? `â€¢ Year ${String(CURRENT_YEAR)}` : "";

      alarmList.innerHTML = "";

      if (!count) {
        const empty = document.createElement("div");
        empty.style.padding = "12px";
        empty.style.fontSize = "0.85rem";
        empty.style.color = "var(--text-muted)";
        empty.textContent = "No alarms right now.";
        alarmList.appendChild(empty);
        return;
      }

      alarms.forEach(a => {
        const item = document.createElement("div");
        item.className = "alarm-item";

        const dot = document.createElement("div");
        dot.className = "alarm-dot " + (a.level === "critical" ? "critical" : (a.level === "warning" ? "warning" : ""));

        const txtWrap = document.createElement("div");

        const t = document.createElement("div");
        t.className = "alarm-text";
        t.textContent = a.message;

        const sub = document.createElement("div");
        sub.className = "alarm-sub";

        if (a._meta && a._meta.dt) {
          sub.textContent = `(${a._meta.dt})`;
        } else if (a.salesCol) {
          const salesText = Number.isFinite(a.sales) ? a.sales.toLocaleString("en-US", { maximumFractionDigits: 2 }) : "";
          sub.textContent = `(${a.salesCol}: ${salesText})`;
        } else {
          sub.textContent = "";
        }

        txtWrap.appendChild(t);
        if (sub.textContent) txtWrap.appendChild(sub);

        item.appendChild(dot);
        item.appendChild(txtWrap);

        item.style.cursor = "pointer";
        item.addEventListener("click", () => {
          closeAlarmPanel();
          focusRowByPk(a.pk);
        });

        alarmList.appendChild(item);
      });
    }

    function openAlarmPanel() { alarmPanel.style.display = "block"; }
    function closeAlarmPanel() { alarmPanel.style.display = "none"; }
    function toggleAlarmPanel() {
      alarmPanel.style.display = (alarmPanel.style.display === "block") ? "none" : "block";
    }

    function focusRowByPk(pk) {
      if (!pk) return;
      searchInput.value = "";
      renderRows(fullItems);

      const idx = fullItems.findIndex(r => (r[PK_NAME] ?? "").toString().trim() === pk);
      if (idx < 0) return;

      const rowId = fullItems[idx]._rowId;
      const tr = tableBody.querySelector(`tr[data-row-id="${rowId}"]`);
      if (tr) tr.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function sortByCompletenessAndReindex() {
      fullItems.sort((a, b) => {
        const ra = a._alarmRank ?? 2;
        const rb = b._alarmRank ?? 2;
        if (ra !== rb) return ra - rb;

        const sa = completenessScore(a);
        const sb = completenessScore(b);
        if (sb !== sa) return sb - sa;

        const oa = Number(a._origOrder) || 0;
        const ob = Number(b._origOrder) || 0;
        if (oa !== ob) return oa - ob;

        const pka = (a[PK_NAME] ?? "").toString();
        const pkb = (b[PK_NAME] ?? "").toString();
        return pka.localeCompare(pkb);
      });

      fullItems.forEach((row, i) => row._idx = i + 1);
    }

    // ========= columns & table render =========
    function buildColumnsFromItems(items) {
      const colSet = new Set();
      (items || []).forEach(row => {
        Object.keys(row || {}).forEach(k => {
          if (k === "_rowId" || k === "_idx" || k === "_origOrder" || k === "_alarmLevel" || k === "_alarmRank") return;
          colSet.add(k);
        });
      });

      if (!colSet.size) colSet.add(PK_NAME);

      const allCols = Array.from(colSet);
      const remaining = allCols.filter(c => !PRIORITY_COLS.includes(c));
      remaining.sort();

      const ordered = PRIORITY_COLS.filter(c => colSet.has(c)).concat(remaining);
      currentColumns = ordered;
    }

    function renderHeader() {
      tableHeaderRow.innerHTML = "";

      const thIdx = document.createElement("th");
      thIdx.textContent = IDX_COL_NAME;
      tableHeaderRow.appendChild(thIdx);

      currentColumns.forEach((col) => {
        const th = document.createElement("th");
        th.textContent = col;
        tableHeaderRow.appendChild(th);
      });

      if (editMode) {
        const thActions = document.createElement("th");
        thActions.textContent = "Actions";
        tableHeaderRow.appendChild(thActions);
      }
    }

    function showFakeDetails(raw) {
      const parts = (raw || "").toString().split(" : ").map(s => s.trim()).filter(Boolean);
      fakeModalBody.innerHTML = "";

      if (!parts.length) {
        fakeModalBody.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„.";
        openFakeModal();
        return;
      }

      parts.forEach((p, i) => {
        const pieces = p.split(",").map(x => (x ?? "").trim());
        const inv = pieces[0] || "-";
        const dt = pieces[1] || "-";
        const tax = pieces[2] || "-";
        const name = pieces[3] || "-";

        const block = document.createElement("div");
        block.className = "fake-invoice-block";
        block.innerHTML = `
          <strong>ØªÙØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</strong>
          Ø¨ØªØ§Ø±ÙŠØ® : ${dt}<br>
          Ø¨Ø±Ù‚Ù… ØªØ³Ø¬ÙŠÙ„ : ${tax}<br>
          Ø¨Ø§Ø³Ù… : ${name}<br>
          Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© : ${inv}
        `;
        fakeModalBody.appendChild(block);

        if (i < parts.length - 1) {
          const hr = document.createElement("hr");
          fakeModalBody.appendChild(hr);
        }
      });

      openFakeModal();
    }

    function renderRows(items) {
      tableBody.innerHTML = "";

      (items || []).forEach(row => {
        const tr = document.createElement("tr");
        tr.dataset.rowId = row._rowId || "";

        if (row._alarmLevel === "fake" || row._alarmLevel === "critical") tr.classList.add("alarm-critical");
        else if (row._alarmLevel === "warning") tr.classList.add("alarm-warning");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = (row._idx != null && row._idx !== "") ? String(row._idx) : "";
        tr.appendChild(tdIdx);

        currentColumns.forEach((col, index) => {
          const td = document.createElement("td");
          td.dataset.colName = col;

          if (col === FAKE_COL && (row[col] ?? "").toString().trim()) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn small danger";
            btn.textContent = "Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„";
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              showFakeDetails(row[col]);
            });
            td.appendChild(btn);
          } else {
            td.textContent = row[col] ?? "";
            td.contentEditable = editMode ? "true" : "false";
          }

          if (index === 0 && col === PK_NAME) td.classList.add("pk-cell");
          tr.appendChild(td);
        });

        if (editMode) {
          const actionsTd = document.createElement("td");
          const delRowBtn = document.createElement("button");
          delRowBtn.type = "button";
          delRowBtn.className = "row-actions-btn";
          delRowBtn.textContent = "ğŸ—‘";
          delRowBtn.addEventListener("click", () => deleteRow(tr.dataset.rowId));
          actionsTd.appendChild(delRowBtn);
          tr.appendChild(actionsTd);
        }

        tableBody.appendChild(tr);
      });

      const rowCount = (items || []).length;
      setRowCount(rowCount);
      hasDataInGrid = rowCount > 0;
      btnUpload.disabled = !hasDataInGrid || !editMode;
    }

    function setData(items) {
      fullItems = (items || []).map((row, i) => {
        const copy = { ...row };
        copy._rowId = generateRowId();
        copy._origOrder = i + 1;
        return copy;
      });

      buildColumnsFromItems(fullItems);

      applyAlarmRanksToRows();
      sortByCompletenessAndReindex();
      buildAlarms();

      renderHeader();
      renderRows(fullItems);
    }

    function applyFilter() {
      const q = searchInput.value.trim().toLowerCase();
      if (!q) {
        renderRows(fullItems);
        setStatus("", "");
        return;
      }

      const filtered = fullItems.filter(row =>
        currentColumns.some(col => ((row[col] ?? "") + "").toLowerCase().includes(q))
      );

      renderRows(filtered);
      setStatus(`Showing ${filtered.length} of ${fullItems.length} rows (filtered).`, "");
    }

    function collectTableDataFromDom() {
      const rows = [];
      const trs = tableBody.querySelectorAll("tr");

      trs.forEach(tr => {
        const rowId = tr.dataset.rowId;
        const srcRow = fullItems.find(r => r._rowId === rowId);
        const tds = Array.from(tr.querySelectorAll("td")).slice(1);
        const obj = {};

        currentColumns.forEach((col, colIndex) => {
          if (col === FAKE_COL) obj[col] = (srcRow?.[FAKE_COL] ?? "");
          else obj[col] = tds[colIndex] ? tds[colIndex].textContent.trim() : "";
        });

        if (obj[PK_NAME]) rows.push(obj);
      });

      return rows;
    }

    function updateEditModeUI() {
      if (editMode) {
        editToggleBtn.classList.add("on");
        editToggleBtn.setAttribute("aria-pressed", "true");
        editControls.style.display = "flex";
        setStatus("Edit mode is ON.", "");
      } else {
        editToggleBtn.classList.remove("on");
        editToggleBtn.setAttribute("aria-pressed", "false");
        editControls.style.display = "none";
        setStatus("", "");
      }
      renderHeader();
      applyFilter();
    }

    function addRow() {
      const newRow = {};
      currentColumns.forEach(col => newRow[col] = "");
      newRow._rowId = generateRowId();
      newRow._origOrder = fullItems.length + 1;

      fullItems.push(newRow);

      applyAlarmRanksToRows();
      sortByCompletenessAndReindex();
      buildAlarms();

      applyFilter();
      setStatus("New empty row added. Fill it then save to server.", "");
    }

    async function deleteRow(rowId) {
      if (!rowId) return;

      const row = fullItems.find(r => r._rowId === rowId);
      if (!row) return;

      const pk = row[PK_NAME];
      if (!pk) {
        alert("This row has no Registration Number, cannot delete on server.");
        return;
      }

      const ok = confirm(`Delete company with Registration Number ${pk} from server?`);
      if (!ok) return;

      try {
        setLoading(true, `Deleting ${pk}...`);

        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            mode: "delete",
            registration_numbers: [pk]
          })
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await parseApiJson(resp);
        const deleted = data.deleted ?? 1;
        if (deleted <= 0) {
          setStatus("Server did not delete any items (maybe key not found).", "error");
          return;
        }

        fullItems = fullItems.filter(r => r._rowId !== rowId);

        applyAlarmRanksToRows();
        sortByCompletenessAndReindex();
        buildAlarms();

        applyFilter();
        setStatus(`Row ${pk} deleted from server.`, "success");
      } catch (err) {
        console.error(err);
        setStatus("Error while deleting row from server.", "error");
      } finally {
        setLoading(false);
      }
    }

    function cancelEdit() {
      if (!baselineItems || !Array.isArray(baselineItems)) return;
      setData(baselineItems);
      searchInput.value = "";
      editMode = false;
      updateEditModeUI();
    }

    async function loadFromServer() {
      try {
        setLoading(true, "Loading data...");

        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode: "list" })
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await parseApiJson(resp);
        const items = data.items || [];

        baselineItems = JSON.parse(JSON.stringify(items));
        setData(items);
        setStatus("", "success");
      } catch (err) {
        console.error(err);
        setStatus("Error while loading data from server.", "error");
      } finally {
        setLoading(false);
      }
    }

    async function uploadGridToServer() {
      const rows = collectTableDataFromDom();
      if (!rows.length) {
        setStatus("There is no data to upload. Make sure there is at least one row with Registration Number.", "error");
        return;
      }

      try {
        setLoading(true, "Saving table (merge, no overwrite) ...");

        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // âœ… merge Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ÙŠÙ…Ø³Ø­Ø´ Ø§Ù„Ù‚Ø¯ÙŠÙ…
          body: JSON.stringify({ mode: "merge", skip_empty: true, records: rows })
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await parseApiJson(resp);
        const merged = data.merged ?? 0;
        const created = data.created ?? 0;
        const errors = data.errors ?? 0;

        if (errors > 0) setStatus(`Saved with warnings: merged ${merged}, created ${created}, errors ${errors}.`, "error");
        else setStatus(`Saved successfully: merged ${merged}, created ${created}.`, "success");

        await loadFromServer();
      } catch (err) {
        console.error(err);
        setStatus("Error while saving data to server.", "error");
      } finally {
        setLoading(false);
      }
    }

    // âœ… Ø¯Ù…Ø¬ Excel Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ÙŠØ³ØªØ¨Ø¯Ù„Ù‡
    function mergeExcelIntoGrid(excelRows) {
      const pkKey = PK_NAME;

      const map = new Map();
      fullItems.forEach(r => {
        const pk = (r[pkKey] ?? "").toString().trim();
        if (pk) map.set(pk, r);
      });

      let updated = 0;
      let added = 0;

      for (const xr of excelRows) {
        const pk = (xr[pkKey] ?? "").toString().trim();
        if (!pk) continue;

        const existing = map.get(pk);

        if (existing) {
          for (const [k, v] of Object.entries(xr)) {
            if (k === pkKey) continue;
            const s = (v ?? "").toString().trim();
            if (!s) continue; // Ø§Ù„ÙØ§Ø¶ÙŠ Ù…Ø§ÙŠÙ„Ù…Ø³Ø´ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            existing[k] = v;
          }
          updated += 1;
        } else {
          const copy = { ...xr };
          copy._rowId = generateRowId();
          copy._origOrder = fullItems.length + 1;
          fullItems.push(copy);
          map.set(pk, copy);
          added += 1;
        }
      }

      buildColumnsFromItems(fullItems);
      applyAlarmRanksToRows();
      sortByCompletenessAndReindex();
      buildAlarms();
      renderHeader();
      applyFilter();

      return { updated, added };
    }

    excelInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) {
        hasDataInGrid = false;
        btnUpload.disabled = true;
        setRowCount(0);
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];

          const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          const validRows = rows.filter(r => r[PK_NAME]);

          if (validRows.length === 0) {
            setStatus("The Excel file does not contain a valid 'Registration Number' column.", "error");
            hasDataInGrid = false;
            btnUpload.disabled = true;
            setData([]);
            return;
          }

          if (fullItems.length) {
            const r = mergeExcelIntoGrid(validRows);
            setStatus(`Excel merged: updated ${r.updated}, added ${r.added}. Now you can save to server.`, "success");
          } else {
            setData(validRows);
            setStatus(`File loaded. ${validRows.length} rows are ready in the grid (you can edit them).`, "success");
          }
        } catch (err) {
          console.error(err);
          setStatus("Error while reading the Excel file.", "error");
          hasDataInGrid = false;
          btnUpload.disabled = true;
        }
      };

      reader.readAsArrayBuffer(file);
    });

    // âœ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© "Ø§Ù„Ø§Ø¯ÙŠØª Ø¨ÙŠÙ‚ÙÙ„": Ù…Ù…Ù†ÙˆØ¹ re-render / sort Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    tableBody.addEventListener("focusin", (e) => {
      if (!editMode) return;
      const td = e.target.closest("td");
      if (!td) return;
      const col = td.dataset.colName;
      if (!col || col === FAKE_COL) return;
      isTypingInCell = true;
    });

    tableBody.addEventListener("input", (e) => {
      if (!editMode) return;

      const td = e.target.closest("td");
      const tr = e.target.closest("tr");
      if (!td || !tr) return;

      const col = td.dataset.colName;
      if (!col || col === FAKE_COL) return;

      const rowId = tr.dataset.rowId;
      const row = fullItems.find(r => r._rowId === rowId);
      if (!row) return;

      row[col] = td.textContent.trim();

      isTypingInCell = true;
      clearTimeout(_typingTimer);
      _typingTimer = setTimeout(() => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† sort/render)
        applyAlarmRanksToRows();
        buildAlarms();
      }, 350);
    });

    tableBody.addEventListener("focusout", (e) => {
      if (!editMode) return;

      const td = e.target.closest("td");
      if (!td) return;
      const col = td.dataset.colName;
      if (!col || col === FAKE_COL) return;

      isTypingInCell = false;

      clearTimeout(_blurRenderTimer);
      _blurRenderTimer = setTimeout(() => {
        // Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØ³ÙŠØ¨ Ø§Ù„Ø®Ø§Ù†Ø©: Ø§Ø¹Ù…Ù„ ØªØ±ØªÙŠØ¨ + Ø±Ù†Ø¯Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        applyAlarmRanksToRows();
        sortByCompletenessAndReindex();
        buildAlarms();
        applyFilter();
      }, 0);
    }, true);

    alarmBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleAlarmPanel();
    });

    alarmClose.addEventListener("click", (e) => {
      e.stopPropagation();
      closeAlarmPanel();
    });

    document.addEventListener("click", (e) => {
      if (!alarmPanel.contains(e.target) && !alarmBtn.contains(e.target)) closeAlarmPanel();
    });

    btnReload.addEventListener("click", loadFromServer);
    btnUpload.addEventListener("click", uploadGridToServer);
    btnAddRow.addEventListener("click", addRow);
    btnCancelEdit.addEventListener("click", cancelEdit);

    searchInput.addEventListener("input", () => {
      // Ù„Ùˆ Ø¨ÙŠÙƒØªØ¨ ÙÙŠ Ø®Ù„ÙŠØ©ØŒ Ù…Ø§ØªØ¹Ù…Ù„Ø´ Ø±Ù†Ø¯Ø± Ø¹Ø´Ø§Ù† Ù…Ø§ÙŠÙÙ‚Ø¯Ø´ Ø§Ù„ÙÙˆÙƒØ³
      if (isTypingInCell) return;
      applyFilter();
    });

    editToggleBtn.addEventListener("click", () => {
      editMode = !editMode;
      updateEditModeUI();
    });

    // âœ… NEW: super-random UUID (same format 8-4-4-4-12)
    function generateUserId() {
      if (window.crypto && typeof crypto.randomUUID === "function") {
        return crypto.randomUUID(); // 8-4-4-4-12
      }
      // fallback
      const bytes = new Uint8Array(16);
      crypto.getRandomValues(bytes);
      // set version (4) and variant (RFC4122)
      bytes[6] = (bytes[6] & 0x0f) | 0x40;
      bytes[8] = (bytes[8] & 0x3f) | 0x80;

      const hex = [...bytes].map(b => b.toString(16).padStart(2, "0")).join("");
      return (
        hex.slice(0, 8) + "-" +
        hex.slice(8, 12) + "-" +
        hex.slice(12, 16) + "-" +
        hex.slice(16, 20) + "-" +
        hex.slice(20)
      );
    }

    // âœ… NEW: Integration Portal click
    btnIntegrationPortal.addEventListener("click", async () => {
    try {
        const userId = generateUserId();
        const url =
        "https://80260658-9969-4960-972a-30a2dce3136f-00-24ift3w1jdzt3.spock.replit.dev:8000/?userId=" +
        encodeURIComponent(userId);

        // ÙØªØ­ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©
        window.location.href = url;

    } catch (e) {
        console.error(e);
        setStatus("Failed to open integration portal.", "error");
    }
    });


    setData([]);
    loadFromServer();
  </script>
</body>

</html>
